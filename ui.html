<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Variables to CSS and Tailwind</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  
  <style>
    /* --- Variables & Theme from figma-ui-kit.html --- */
    :root {
      --font-sans: 'Inter', -apple-system, system-ui, "SF Pro Text", Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      
      --radius-lg: 8px;
      --radius: 4px;
      
      --shadow-md: 0 4px 12px rgb(0 0 0 / 0.1);
      
      /* Palette */
      --bg: #262626;
      --surface: #2C2C2C;
      --border: #444444;
      --muted: #454545;
      --text: #fbfbfb;
      --text-muted: #dedede;
      --accent: #f7f7f7;
      
      --ring: 0 0 0 1px #b5b5b5;
      --ring-color: #b5b5b5;
      
      /* UI Kit Colors */
      --btn-default-bg: #fbfbfb;
      --btn-default-fg: #252525;
      --btn-default-hover: #f7f7f7;
      --btn-secondary-bg: #5f5f5f;
      --btn-secondary-fg: #fbfbfb;
      --btn-secondary-hover: #707070;
      --btn-destructive-bg: #ef4444;
      --btn-destructive-fg: #ffffff;
      --btn-destructive-hover: #dc2626;
      
      --editor-bg: #383838;
      --row-h: 44px;
      --tbody-rows: 10;
      --checkbox-border: #595959;
    }

    /* --- Base & Layout --- */
    * { box-sizing: border-box; }
    html { font-size: 16px; }
    body {
      margin: 0;
      padding: 24px;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-sans);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap { 
      width: 100%;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }
    .form-group > * + * { margin-top: 6px; }
    .stack-16 > * + * { margin-top: 16px; }


    /* --- Components --- */
    .section-header { 
      padding-bottom: 12px; 
    }
    .section-title { font-weight: 600; color: var(--text-muted); text-transform: none; letter-spacing: normal; font-size: 14px; margin:0; }
    .section-description { font-size: 12px; color: var(--text-muted); margin: 4px 0 0 0; }
    .section-body { 
      padding: 16px; 
      display: grid; 
      gap: 16px; 
      background: var(--surface);
      border: 0.5px solid var(--border);
      border-radius: var(--radius-lg);
    }

    /* Form Elements */
    .input, .select, .btn, .textarea {
      height: 34px;
    }
    .input, .select, .textarea {
      width: 100%;
      border: none;
      background: var(--editor-bg);
      color: var(--text);
      padding: 0 12px;
      border-radius: var(--radius);
      outline: none;
      transition: box-shadow .12s;
      font-size: 14px;
      font-family: var(--font-sans);
    }
    .textarea {
        height: 180px;
        padding: 8px 12px;
        resize: vertical;
        font-family: var(--font-mono);
    }
    .input:focus, .select:focus, .textarea:focus { box-shadow: var(--ring); }
    .label { display: block; color: var(--text-muted); font-size: 12px; }
    .select {
      appearance: none;
      line-height: 34px;
      padding-right: 28px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23dedede' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 16px 16px;
    }
    .check {
      appearance: none;
      display: grid;
      place-content: center;
      margin: 0;
      cursor: pointer;
      width: 16px;
      height: 16px;
      border: 1px solid var(--checkbox-border);
      border-radius: 4px;
      background: var(--editor-bg);
      transition: box-shadow .12s, border-color .12s, background .12s;
    }
    .check:hover { background: var(--muted); }
    .check:focus { 
      box-shadow: var(--ring);
      border-width: 1px;
      border-style: solid;
    }
    .check:checked { 
      border-width: 1px;
      border-style: solid;
      border-color: var(--ring-color); 
      background: var(--editor-bg); 
    }
    .check:checked::after {
      content: "";
      width: 12px;
      height: 12px;
      display: block;
      background-repeat: no-repeat;
      background-position: center;
      background-size: 12px 12px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23fafafa' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'/%3E%3C/svg%3E");
    }
    .radio { border-radius: 999px; }
    .radio:checked::after {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'%3E%3Ccircle cx='6' cy='6' r='4' fill='%23fafafa'/%3E%3C/svg%3E");
    }

    /* Pills (Tabs) */
    .pills { display: flex; flex-wrap: wrap; gap: 8px; }
    .pill { 
      display: inline-flex; 
      align-items: center; 
      gap: 6px; 
      padding: 0 12px; 
      border-radius: var(--radius); 
      border: none; 
      background: var(--editor-bg); 
      color: var(--text-muted); 
      font-weight: 600; 
      font-size: 12px; 
      cursor: pointer; 
      height: 28px;
    }
    .pill:active { transform: translateY(1px); }
    .pill.active { 
      color: var(--bg); 
      background: var(--text);
    }
    
    /* Switch */
    .switch { position: relative; display: inline-flex; align-items: center; width: 36px; height: 20px; vertical-align: middle; }
    .switch-input { position: absolute; inset: 0; margin: 0; opacity: 0; cursor: pointer; }
    .switch-track { position: relative; width: 100%; height: 100%; border-radius: 9999px; cursor: pointer; background-color: #454545; transition: background-color 160ms ease; }
    .switch-knob { position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; border-radius: 9999px; background-color: #ffffff; transition: transform 160ms cubic-bezier(.22, 1, .36, 1); }
    .switch-input:checked + .switch-track { background-color: #8e8e8e; }
    .switch-input:checked + .switch-track + .switch-knob { transform: translateX(16px); }
    .switch-input:focus-visible + .switch-track { box-shadow: var(--ring); }

    /* Accordion */
    .accordion { border: 0.5px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .acc-item + .acc-item { border-top: 0.5px solid var(--border); }
    .acc-header-btn { all: unset; box-sizing: border-box; display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; background: var(--editor-bg); cursor: pointer; }
    .acc-header-btn:hover { background: var(--muted); }
  .acc-meta { flex: 1; display: flex; flex-direction: column; gap: 4px; }
  .acc-title { text-align: left; color: var(--accent); font-weight: 500; font-size: 14px; }
  .acc-count { color: var(--text-muted); font-size: 12px; }
    .acc-chevron { transition: transform .16s ease; color: var(--text-muted); cursor: pointer; }
    .acc-panel { display: grid; grid-template-rows: 0fr; transition: grid-template-rows .18s ease; background: var(--editor-bg); }
    .acc-panel[aria-hidden="false"] { grid-template-rows: 1fr; }
    .acc-panel-inner { overflow: hidden; }
    .subrow { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 8px 12px 8px 40px; border-top: 0.5px solid rgba(251, 251, 251, .04); }
    .subrow:hover { background: rgba(251, 251, 251, .02); }
    .sub-label { flex: 1; color: var(--text); font-size: 14px; }

    /* Actions & KBD */
    .actions { display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap; }
    .btn {
      appearance: none; user-select: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
      gap: 8px; font-weight: 600; font-size: 14px; border-radius: var(--radius); border: 1px solid transparent;
      transition: transform .06s, background-color .12s, color .12s, border-color .12s, box-shadow .12s;
      padding: 0 16px; line-height: 1;
    }
    .btn:focus-visible { outline: none; box-shadow: var(--ring); }
    .btn:active { transform: translateY(1px); }
    .btn--default { background: var(--btn-default-bg); color: var(--btn-default-fg); }
    .btn--default:hover { background: var(--btn-default-hover); }
    .btn--secondary { background: var(--btn-secondary-bg); color: var(--btn-secondary-fg); }
    .btn--secondary:hover { background: var(--btn-secondary-hover); }
    .kbd{
      font-family: var(--font-mono); font-size: .75rem; padding:2px 6px; border-radius: 4px;
      background: #454545; border:1px solid #595959; color: var(--text-muted);
    }
    
    /* Toast */
    .toast { position: fixed; right: 16px; bottom: 16px; padding: 10px 12px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--surface); color: var(--accent); box-shadow: var(--shadow-md); transform: translateY(16px); opacity: 0; pointer-events: none; transition: .2s ease; }
    .toast.show { transform: translateY(0); opacity: 1; }

    /* Scrollbar */
    *::-webkit-scrollbar { width: 10px; height: 10px; }
    *::-webkit-scrollbar-track { background: var(--bg); }
    *::-webkit-scrollbar-thumb { background: #5f5f5f; border-radius: 8px; border: 2px solid var(--bg); }
    *::-webkit-scrollbar-thumb:hover { background: #707070; }
  </style>
</head>
<body>

<div class="wrap">
  <div class="stack-16">
    <!-- Secciones apiladas verticalmente -->
    <div>
      <header class="section-header">
        <h2 class="section-title">Collections</h2>
        <p class="section-description">Select the ones you want to export</p>
      </header>
      <div class="section-body">
        <div id="collections" class="accordion"></div>
      </div>
    </div>
    
    <div>
      <header class="section-header">
        <h2 class="section-title">Options</h2>
      </header>
      <div class="section-body">
        <div class="form-group">
            <label class="label">Naming Convention</label>
            <div style="display: flex; gap: 16px; margin-top: 4px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input class="check radio" type="radio" name="namemode" value="code-syntax" checked>
                    <span style="font-size: 14px; color: var(--text);">Code Syntax</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input class="check radio" type="radio" name="namemode" value="figma-name">
                    <span style="font-size: 14px; color: var(--text);">Figma Names</span>
                </label>
            </div>
        </div>
        <div class="form-group">
            <label class="label">Formats</label>
            <div style="display: flex; gap: 16px; margin-top: 4px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input id="fmt-css" class="check" type="checkbox" checked>
                    <span style="font-size: 14px; color: var(--text);">CSS</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input id="fmt-tw" class="check" type="checkbox" checked>
                    <span style="font-size: 14px; color: var(--text);">Tailwind</span>
                </label>
            </div>
        </div>
        <div class="form-group">
          <label for="prefix" class="label">Prefix</label>
          <input id="prefix" class="input" placeholder="e.g., ds" />
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input id="unitpx" class="check" type="checkbox" checked>
            <span style="font-size: 14px; color: var(--text);">Append "px" to FLOAT variables</span>
          </label>
        </div>
      </div>
    </div>

    <div>
      <header class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 class="section-title">Output</h2>
        <div class="pills">
          <button id="tab-css" class="pill active" type="button">CSS</button>
          <button id="tab-tw" class="pill" type="button">Tailwind</button>
        </div>
      </header>
      <div class="section-body">
        <textarea id="out-css" class="textarea" aria-label="CSS code" placeholder=":root { --token: value; }"></textarea>
        <textarea id="out-tw" class="textarea" aria-label="Tailwind snippet" style="display:none" placeholder="theme.extend.colors = {}"></textarea>
        <textarea id="out-sd" class="textarea" aria-label="Style Dictionary JSON" style="display:none" placeholder="{ \"color\": { ... } }"></textarea>
        <div class="actions" style="margin-top: 8px;">
          <button id="copy-css" class="btn btn--secondary">Copy CSS</button>
          <button id="copy-tw" class="btn btn--secondary">Copy Tailwind</button>
          <button id="run" class="btn btn--default">Generate</button>
          <button id="export-sd" class="btn btn--default">Export SD JSON</button>
        </div>
      </div>
    </div>
    
    <div>
      <header class="section-header">
        <h2 class="section-title">Quick Help</h2>
      </header>
      <div class="section-body">
        <div style="font-size: 12px; color: var(--text-muted); line-height: 1.6;">
          • <b>Code Syntax</b> normalizes names for code.<br/>
          • Select collections and click <b>Generate</b>.<br/>
          • Use <span class="kbd">Copy CSS</span> or <span class="kbd">Copy Tailwind</span>.
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite">Copied</div>

<script>
    // ===== Utils
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
    function copyFrom(id){ const ta=document.getElementById(id); ta.select(); document.execCommand('copy'); toast('Copied to clipboard'); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ===== Accordion interactivity
    document.addEventListener('click', (e) => {
      const headerBtn = e.target.closest('.acc-header-btn');
      if (!headerBtn) return;

      const panel = headerBtn.nextElementSibling;
      const chevron = headerBtn.querySelector('.acc-chevron');
      const mainCheckbox = headerBtn.querySelector('.coll-check');

      // If the item can expand (has chevron) => clicking header toggles expansion
      if (chevron) {
        // If click is on the chevron itself, toggle as before
        if (chevron.contains(e.target)) {
          if (panel) {
            const isHidden = panel.getAttribute('aria-hidden') === 'true';
            panel.setAttribute('aria-hidden', String(!isHidden));
            headerBtn.setAttribute('aria-expanded', String(isHidden));
            chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0)';
          }
        }
        // If click is anywhere in the header but NOT the checkbox, also toggle expansion
        else if (mainCheckbox && e.target !== mainCheckbox) {
          if (panel) {
            const isHidden = panel.getAttribute('aria-hidden') === 'true';
            panel.setAttribute('aria-hidden', String(!isHidden));
            headerBtn.setAttribute('aria-expanded', String(isHidden));
            chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0)';
          }
        }
        // If click was directly on the checkbox, let the checkbox handle the event naturally
        return;
      }

      // If the item cannot expand: clicking anywhere in the header toggles the actionable input
      // Find an actionable input inside the header (checkbox, radio, switch)
      const actionable = mainCheckbox || headerBtn.querySelector('input[type="checkbox"], input[type="radio"], .switch-input');
      if (actionable && e.target !== actionable) {
        actionable.checked = !actionable.checked;
        actionable.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });

    // ===== Tabs
    const tabCss=$('#tab-css'), tabTw=$('#tab-tw');
    const outCss=$('#out-css'), outTw=$('#out-tw');
    function activateTab(t){
      const copyCssBtn = $('#copy-css');
      const copyTwBtn = $('#copy-tw');
      if(t==='css'){
        tabCss.classList.add('active'); tabTw.classList.remove('active');
        outCss.style.display=''; outTw.style.display='none';
        copyCssBtn.style.display=''; copyTwBtn.style.display='none';
      }
      else{
        tabTw.classList.add('active'); tabCss.classList.remove('active');
        outTw.style.display=''; outCss.style.display='none';
        copyTwBtn.style.display=''; copyCssBtn.style.display='none';
      }
    }
    tabCss.addEventListener('click',()=>activateTab('css'));
    tabTw.addEventListener('click',()=>activateTab('tw'));
    activateTab('css'); // Initialize correctly

    // ===== Collections
    function renderCollections(items){
      const box = $('#collections');
      if(!items || !items.length){
        box.innerHTML = `<div style="color: var(--text-muted); font-size: 14px;">No local collections found.</div>`;
        return;
      }
      box.innerHTML = items.map(it => {
        const modes = (it.modes || []);
        const hasMultiple = modes.length > 1;
        
        const modeList = hasMultiple ? (
          '<div class="acc-panel-inner">' + modes.map(m => `
            <label class="subrow">
              <div class="sub-label">${escapeHtml(m.name || m.modeId)}</div>
              <span class="switch">
                <input type="checkbox" class="switch-input mode-check" value="${m.modeId}" disabled>
                <span class="switch-track"></span><span class="switch-knob"></span>
              </span>
            </label>
          `).join('') + '</div>'
        ) : '';

        const singleAttr = (!hasMultiple && modes.length === 1) ? ` data-single-mode-id="${modes[0].modeId}"` : '';

        return `
          <div class="acc-item" data-collection-id="${it.id}"${singleAttr}>
            <div class="acc-header-btn" aria-expanded="false">
              <input type="checkbox" class="check coll-check" value="${it.id}">
              <div class="acc-meta">
                <div class="acc-title">${escapeHtml(it.name)}</div>
                <div class="acc-count">${it.variableCount} vars</div>
              </div>
              ${hasMultiple ? `<span class="acc-chevron"><svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="m19.5 8.25-7.5 7.5-7.5-7.5"/></svg></span>` : ''}
            </div>
            ${hasMultiple ? `<div class="acc-panel" aria-hidden="true">${modeList}</div>` : ''}
          </div>
        `;
      }).join('');

      $$('#collections .coll-check').forEach(chk => {
        const container = chk.closest('[data-collection-id]');
        const modeSwitches = Array.from(container.querySelectorAll('.mode-check'));
        
        const setEnabled = (enabled) => {
          modeSwitches.forEach(s => { s.disabled = !enabled; });
        };
        
        setEnabled(false);
        chk.addEventListener('change', () => {
          const enabled = chk.checked;
          setEnabled(enabled);
          if (enabled) {
            if (modeSwitches.length > 0 && !modeSwitches.some(s => s.checked)) {
              modeSwitches.forEach(s => s.checked = true);
            } else {
              const single = container.getAttribute('data-single-mode-id');
              if (single) container.setAttribute('data-single-mode-selected', single);
            }
          } else {
            modeSwitches.forEach(s => s.checked = false);
            container.removeAttribute('data-single-mode-selected');
          }
        });
      });
    }

    function getModesByCollection(){
      const map = {};
      $$('#collections .acc-item').forEach(row => {
        const id = row.getAttribute('data-collection-id');
        const checked = row.querySelector('.coll-check')?.checked;
        if(checked){
          const selectedModes = Array.from(row.querySelectorAll('.mode-check:checked')).map(i => i.value);
          if (selectedModes.length) {
            map[id] = selectedModes.join(',');
          } else {
            const implicitMode = row.getAttribute('data-single-mode-selected') || row.getAttribute('data-single-mode-id');
            if (implicitMode) {
              map[id] = implicitMode;
            }
          }
        }
      });
      return map;
    }

    function getNameMode(){ const r=$('input[name="namemode"]:checked'); return (r?.value||'code-syntax'); }
    function getFormats(){ const a=[]; if($('#fmt-css').checked)a.push('css'); if($('#fmt-tw').checked)a.push('tailwind'); return a; }

    // ===== Actions
    $('#copy-css').addEventListener('click',()=>copyFrom('out-css'));
    $('#copy-tw').addEventListener('click',()=>copyFrom('out-tw'));
    $('#run').addEventListener('click',()=>{
      const payload = {
        collectionIds: $$('#collections .coll-check:checked').map(i=>i.value),
        nameMode: getNameMode(),
        format: getFormats(),
        unitPxForFloat: $('#unitpx').checked,
        prefix: $('#prefix').value.trim(),
        modesByCollection: getModesByCollection()
      };
      parent.postMessage({ pluginMessage: { type:'RUN', payload } }, '*');
    });

    // ===== Plugin messaging
    window.onmessage = (e)=>{
      const msg = e.data.pluginMessage || {};
      if(msg.type==='INIT_DATA'){ renderCollections(msg.payload); }
      if(msg.type==='RESULT'){
        const { css, tailwind, sdTokens } = msg.payload || {};
        outCss.value = css || '';
        outTw.value = tailwind || '';
        if (sdTokens) {
          document.getElementById('out-sd').value = JSON.stringify(sdTokens, null, 2);
          document.getElementById('out-sd').style.display = '';
        }
        const fmts = getFormats();
        if(fmts.length===1){ activateTab(fmts[0]==='css'?'css':'tw'); }
        else if (fmts.includes('css')) { activateTab('css'); }
        else if (fmts.includes('tailwind')) { activateTab('tw'); }
      }
    };
    parent.postMessage({ pluginMessage: { type:'INIT' } }, '*');

    document.getElementById('export-sd').addEventListener('click', () => {
      const text = document.getElementById('out-sd').value;
      if (!text) return toast('No SD JSON available');
      const blob = new Blob([text], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'tokens.json'; a.click(); URL.revokeObjectURL(url);
      toast('SD JSON descargado');
    });
</script>

</body>
</html>
